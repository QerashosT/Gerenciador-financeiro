<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Not√≠cias Financeiras ‚Äî Brasil</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="navbar">
    <div class="nav-left">
      <a href="/" class="btn ghost">‚Üê Voltar</a>
    </div>
    <div class="nav-center">
      <div class="logo-text"><strong>Not√≠cias</strong><small>Brasil ‚Äî Economia / Agro / Neg√≥cios / Cripto</small></div>
    </div>
    <div class="nav-right">
      <button id="newsThemeToggle" class="btn nav-btn" title="Alternar tema">üåô</button>
    </div>
  </header>

  <main style="max-width:1200px;margin:84px auto;padding:18px;">
    <section style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <input id="newsSearch" placeholder="Buscar not√≠cias (titulo / fonte)..." style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)">
      <select id="newsSource"><option value="">Todas as fontes</option></select>
      <select id="newsTag"><option value="">Todos temas</option><option value="economia">Economia</option><option value="agro">Agro</option><option value="cripto">Cripto</option><option value="negocios">Neg√≥cios</option><option value="politica">Pol√≠tica</option></select>
      <button id="refreshNews" class="btn">Atualizar</button>
    </section>

    <section class="news-grid" id="newsGrid">
      {% for item in news %}
      <article class="news-card" data-source="{{ item.source }}">
        {% if item.image %}
          <div class="news-thumb" style="height:160px;overflow:hidden;border-radius:8px;margin-bottom:12px">
            <img src="{{ item.image }}" alt="" style="width:100%;height:100%;object-fit:cover"/>
          </div>
        {% endif %}
        <h3><a href="{{ item.link }}" target="_blank" rel="noopener">{{ item.title }}</a></h3>
        <p class="muted" style="margin:6px 0 12px 0">{{ item.source }} ‚Ä¢ {{ item.published }}</p>
        <div class="news-actions" style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <a class="read-more" href="{{ item.link }}" target="_blank" rel="noopener">Ler no site ‚Üí</a>
          <div class="news-tags">
            {% if 'agro' in (item.title|lower) or 'agroneg√≥cio' in (item.title|lower) %}<span class="tag">Agro</span>{% endif %}
            {% if 'bolsa' in (item.title|lower) or 'mercado' in (item.title|lower) or 'econom' in (item.title|lower) %}<span class="tag">Economia</span>{% endif %}
            {% if 'cripto' in (item.title|lower) or 'bitcoin' in (item.title|lower) or 'crypto' in (item.title|lower) %}<span class="tag">Cripto</span>{% endif %}
          </div>
        </div>
      </article>
      {% endfor %}
    </section>
  </main>

  <script>
    window.INITIAL_NEWS = {{ news|tojson }};
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const grid = document.getElementById('newsGrid');
      const sourceSel = document.getElementById('newsSource');
      const search = document.getElementById('newsSearch');
      const tagSel = document.getElementById('newsTag');
      let news = window.INITIAL_NEWS || [];

      function render(list){
        grid.innerHTML = '';
        list.forEach(it => {
          const article = document.createElement('article'); article.className = 'news-card'; article.dataset.source = it.source;
          if(it.image){
            const d = document.createElement('div'); d.className='news-thumb'; d.style.height='160px'; d.style.overflow='hidden'; d.style.borderRadius='8px'; d.style.marginBottom='12px';
            const img = document.createElement('img'); img.src = it.image; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
            d.appendChild(img); article.appendChild(d);
          }
          const h = document.createElement('h3'); h.innerHTML = `<a href="${it.link}" target="_blank" rel="noopener">${it.title}</a>`; article.appendChild(h);
          const p = document.createElement('p'); p.className='muted'; p.style.margin='6px 0 12px 0'; p.textContent = `${it.source} ‚Ä¢ ${it.published || ''}`; article.appendChild(p);
          const footer = document.createElement('div'); footer.className='news-actions'; footer.style.display='flex'; footer.style.justifyContent='space-between';
          const a = document.createElement('a'); a.className='read-more'; a.href = it.link; a.target='_blank'; a.rel='noopener'; a.textContent='Ler no site ‚Üí';
          footer.appendChild(a);
          const tagsDiv = document.createElement('div');
          const titleLower = (it.title||'').toLowerCase();
          if(titleLower.includes('agro') || titleLower.includes('agroneg√≥cio')) tagsDiv.innerHTML += '<span class="tag">Agro</span>';
          if(titleLower.includes('bolsa') || titleLower.includes('mercado') || titleLower.includes('econom')) tagsDiv.innerHTML += '<span class="tag">Economia</span>';
          if(titleLower.includes('cripto') || titleLower.includes('bitcoin') || titleLower.includes('crypto')) tagsDiv.innerHTML += '<span class="tag">Cripto</span>';
          footer.appendChild(tagsDiv);
          article.appendChild(footer);
          grid.appendChild(article);
        });
      }

      // populate sources
      function populateSources(list) {
        const uniq = Array.from(new Set(list.map(n=>n.source))).sort();
        sourceSel.innerHTML = '<option value="">Todas as fontes</option>';
        uniq.forEach(s => sourceSel.appendChild(new Option(s,s)));
      }

      render(news);
      populateSources(news);

      document.getElementById('refreshNews').addEventListener('click', async () => {
        try {
          const res = await fetch('/api/news?limit=40');
          const updated = await res.json();
          news = updated;
          render(news);
          populateSources(news);
        } catch(e){ console.error(e); alert('Erro ao atualizar not√≠cias'); }
      });

      function applyFilters(){
        const q = search.value.trim().toLowerCase();
        const s = sourceSel.value;
        const tag = tagSel.value;
        let filtered = news.slice();
        if (s) filtered = filtered.filter(x=>x.source === s);
        if (tag) {
          filtered = filtered.filter(x => {
            const t = (x.title||'').toLowerCase();
            if (tag === 'agro') return t.includes('agro') || t.includes('agroneg√≥cio');
            if (tag === 'economia') return t.includes('bolsa') || t.includes('mercado') || t.includes('econom');
            if (tag === 'cripto') return t.includes('cripto') || t.includes('bitcoin') || t.includes('crypto');
            if (tag === 'negocios') return t.includes('empresa') || t.includes('neg√≥cio') || t.includes('fus√£o') || t.includes('aquisi√ß√£o');
            if (tag === 'politica') return t.includes('governo') || t.includes('pol√≠tica') || t.includes('minister') || t.includes('congresso');
            return true;
          });
        }
        if (q) filtered = filtered.filter(x => (x.title + ' ' + (x.source||'')).toLowerCase().includes(q));
        render(filtered);
      }

      sourceSel.addEventListener('change', applyFilters);
      search.addEventListener('input', applyFilters);
      tagSel.addEventListener('change', applyFilters);

      // dark toggle for news page
      const newsThemeToggle = document.getElementById('newsThemeToggle');
      (function initTheme(){ const stored = localStorage.getItem('fp_theme_v1'); document.documentElement.setAttribute('data-theme', stored === 'dark' ? 'dark' : 'light'); newsThemeToggle.textContent = stored === 'dark' ? '‚òÄÔ∏è' : 'üåô' })();
      newsThemeToggle.addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('fp_theme_v1', next);
        newsThemeToggle.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      });
    });
  </script>
</body>
</html>
